name: Implement New Collector

env:
  DOTNET_VERSION: "8.0.x"

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  check_trigger:
    name: Check Trigger
    runs-on: ubuntu-latest
    if: |
      github.event.issue.pull_request == null &&
      contains(github.event.issue.labels.*.name, 'New Collector') &&
      (github.event.comment.body == '/implement' || github.event.comment.body == '/implement-collector')
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      issue_number: ${{ steps.get_issue.outputs.issue_number }}
      issue_body: ${{ steps.get_issue.outputs.issue_body }}
      council_name: ${{ steps.get_issue.outputs.council_name }}
      council_name_pascal: ${{ steps.get_issue.outputs.council_name_pascal }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if comment author has write access
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/implement-collector/check-user-permission.js');
            await script({ github, context, core });

      - name: Get issue details
        id: get_issue
        if: steps.check.outputs.should_run == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/implement-collector/parse-issue-details.js');
            await script({ github, context, core });

      - name: Add reaction to comment
        if: steps.check.outputs.should_run == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

  implement_collector:
    name: Implement Collector
    needs: check_trigger
    if: needs.check_trigger.outputs.should_run == 'true'
    runs-on: self-hosted
    timeout-minutes: 180
    env:
      AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
    steps:
      - name: Generate GitHub App token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Install AI Tools
        uses: ./.github/actions/install-ai-tools
        with:
          codex_config: ${{ secrets.CODEX_CONFIG }}
          playwright_config: |
            {
              "browser": {
                "browserName": "firefox",
                "launchOptions": {
                  "headless": true
                },
                "contextOptions": {
                  "recordHar": {
                    "path": "./.agent/playwright/out/requests.har",
                    "content": "embed"
                  }
                }
              },
              "outputDir": "./.agent/playwright/out",
              "saveTrace": true,
              "isolated": true
            }

      - name: Create output directory
        run: mkdir -p .agent/playwright/out

      - name: Write issue body to file
        run: |
          cat << 'ISSUE_EOF' > .agent/playwright/out/issue_body.txt
          ${{ needs.check_trigger.outputs.issue_body }}
          ISSUE_EOF

      - name: Setup PATH for Codex subshells
        run: |
          # Ensure dotnet is available in login shells spawned by Codex
          DOTNET_PATH=$(dirname "$(which dotnet)")
          echo "export PATH=\"$DOTNET_PATH:\$PATH\"" >> ~/.bashrc

          # Verify it works in a login shell
          bash -lc 'dotnet --version'

      - name: Implement collector with Codex
        env:
          ISSUE_TITLE: ${{ needs.check_trigger.outputs.council_name }}
          ISSUE_NUMBER: ${{ needs.check_trigger.outputs.issue_number }}
          BINDAYS_ENABLE_HTTP_LOGGING: "true"
        run: ./.github/scripts/implement-collector/implement-collector.sh

      - name: Verify implementation
        env:
          COLLECTOR_NAME: ${{ needs.check_trigger.outputs.council_name_pascal }}
        run: ./.github/scripts/implement-collector/verify-implementation.sh

      - name: Run final integration tests
        env:
          COLLECTOR_NAME: ${{ needs.check_trigger.outputs.council_name_pascal }}
        run: ./.github/scripts/implement-collector/run-collector-tests.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: collector-data
          path: |
            .agent/playwright/out/*.json
            .agent/playwright/out/*.har
            .agent/playwright/out/*.zip
            .agent/playwright/out/*.png
          retention-days: 7
          if-no-files-found: ignore

      - name: Create branch and commit
        id: commit
        env:
          COLLECTOR_NAME: ${{ needs.check_trigger.outputs.council_name_pascal }}
          ISSUE_NUMBER: ${{ needs.check_trigger.outputs.issue_number }}
        run: ./.github/scripts/implement-collector/create-branch-and-commit.sh

      - name: Refresh GitHub App token
        id: refresh-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}

      - name: Create Pull Request
        uses: actions/github-script@v7
        env:
          COUNCIL_NAME: ${{ needs.check_trigger.outputs.council_name }}
          COUNCIL_NAME_PASCAL: ${{ needs.check_trigger.outputs.council_name_pascal }}
          BRANCH_NAME: ${{ steps.commit.outputs.branch_name }}
          ISSUE_NUMBER: ${{ needs.check_trigger.outputs.issue_number }}
        with:
          github-token: ${{ steps.refresh-token.outputs.token }}
          script: |
            const script = require('./.github/scripts/implement-collector/create-pr.js');
            await script({ github, context, core });

  report_failure:
    name: Report Failure
    needs: [check_trigger, implement_collector]
    if: failure() && needs.check_trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Comment on issue about failure
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ needs.check_trigger.outputs.issue_number }}
        with:
          script: |
            const script = require('./.github/scripts/implement-collector/report-failure.js');
            await script({ github, context, core });
